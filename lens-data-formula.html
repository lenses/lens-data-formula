<link rel="import" href="../polymer/polymer.html"> 
<link rel="import" href="../lens-u-data-utility/lens-u-data-utility.html"> 
<link rel="import" href="../iron-selector/iron-selector.html"> 
<link rel="import" href="../iron-input/iron-input.html"> 

<!--
A data transform component for applying a mathematical formula on input.

##### Example

    <lens-data-formula></lens-data-formula>

@element lens-data-formula
@blurb A data transform component for applying mathematical formula on input.
@status alpha
@homepage http://lenses.github.io/lens-data-formula
-->

<dom-module id="lens-data-formula">
  <link rel="import" type="css" href="lens-data-formula.css">
  <template>
    <lens-u-data-utility id="data_utility"></lens-u-data-utility>

      <div class="lens-container lens-data">
            <p class="info">Calculate a mathematical formula based on column values</p>
            <label>Formula:</label>
            <input is="core-input" id="formula" value="{{formula::input}}" class="formula" placeholder="e.g. col1 + col2">
            <label>Name of the new calculated column:</label>
            <input is="core-input" id="colNameField" committedvalue="{{resultColumnName}}">            
            <label>Available columns:</label>
            <iron-selector id="col_selector" selected="{{_selectedCol}}" attr-for-selected="label">
              <template is="dom-repeat" items="{{_dataAttributes}}" as="attr">
                <div class="col" label="{{attr}}">{{attr}}</div>
              </template>
            </iron-selector>
            <label>Available functions:</label>
            <iron-selector id="func_selector" selected="{{_selectedFunc}}" attr-for-selected="label">
              <template is="dom-repeat" items="{{_functions}}" as="func">
                <div class="col" label="{{func}}">{{func}}</div>
              </template>
            </iron-selector>
      </div>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'lens-data-formula',
    properties: {
      formula: {
        type: String,
        value: '',
        notify: true,
        observer: 'formulaChanged'
      },
      input: {
        type: Array,
        value: function () {
          return [];
        },
        notify: true,
        observer: 'inputChanged'
      },
      output: {
        type: Array,
        value: function () {
          return [];
        },
        notify: true
      },
      resultColumnName: {
        type: String,
        value: 'result',
        notify: true,
        observer: '_calculateOutput'
      },
      _functions: {
        type: Array,
        value: function () {
          return [
            'sqrt(x)',
            'log(x)',
            'exp(x)',
            'abs(x)',
            'round(x)',
            'ceil(x)',
            'floor(x)',
            'sin(x)',
            'cos(x)',
            'tan(x)',
            'asin(x)',
            'acos(x)',
            'atan(x)'
          ];
        }
      },
      _invalidCharsRegex: { value: /[\s\(\)]/g }
    },
    _calculateOutput: function () {
      var self = this;
      if (self.input && self.formula && self.formula.length > 0) {
        try {
          var expr = Parser.parse(self.formula);
        } catch (e) {
          console.log(e.message);
          return;
        }
        var vars = expr.variables();
        self.output = self.input.map(function (item) {
          var clone = self.$.data_utility.clone(item);  //escape space in key names to get valid math formula
          //escape space in key names to get valid math formula
          var spaceEscapedNames = {};
          for (key in clone) {
            spaceEscapedNames[key.replace(self._invalidCharsRegex, '_')] = clone[key];
          }
          var unformatted = self.$.data_utility.unformatObject(spaceEscapedNames);  //var ret = self.$.data_utility.unformatObject(clone, false);
          //var ret = self.$.data_utility.unformatObject(clone, false);
          try {
            clone[self.resultColumnName] = expr.evaluate(unformatted);
          } catch (e) {
            console.log(e.message);
            return;
          }
          return clone;
        });

        self.fire('lens-output-changed' , self.output);
      }
    },
    inputChanged: function () {
      var self = this;
      var firstItem = self.input[0];
      if (!firstItem) {
        return;
      }
      var attributes = Object.keys(firstItem);
      if (JSON.stringify(self._dataAttributes) === JSON.stringify(attributes)) {
      }  //self._mapChartData();
      else
        //self._mapChartData();
        {
          self._dataAttributes = attributes;
        }
      self._calculateOutput();
    },
    _colSelected: function (e) {
      var self = this;
      if (self._selectedCol) {
        self.formula = (self.formula === undefined ? '' : self.formula).concat(' ' + self._selectedCol.replace(self._invalidCharsRegex, '_') + ' ');
      }
      self.$.formula.focus();
    },
    _funcSelected: function (e) {
      var self = this;
      if (self._selectedFunc) {
        self.formula = (self.formula === undefined ? '' : self.formula).concat(' ' + self._selectedFunc.substring(0, self._selectedFunc.length - 2) + ' ');
      }
      self.$.formula.focus();
    },
    resultColumnNameChanged: function () {
      this._calculateOutput();
    },
    formulaChanged: function () {
      this._calculateOutput();
    },
    ready: function () {
      var self = this;  //to render available columns if any
      //to render available columns if any
      this.$.colNameField.value = this.resultColumnName;
      this.$.col_selector.addEventListener('iron-select', function (e) {
        self._colSelected(e);
      });
      this.$.func_selector.addEventListener('iron-select', function (e) {
        self._funcSelected(e);
      });
    }
  });
</script><script src="js/parser.js"></script>
