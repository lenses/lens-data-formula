<link rel="import" href="../polymer/polymer.html"> 

<!--
A Thelma component for applying mathematical functions on input.

##### Example

    <th-math-formula></th-math-formula>

@element th-math-formula
@blurb A Thelma component for applying mathematical functions on input.
@status alpha
@homepage http://thelmanews.github.io/th-math-formula
-->

<polymer-element name="th-math-formula" attributes="input output">
  <template>
    <th-data-utility id="data_utility"></th-data-utility>
    <link rel="stylesheet" href="th-math-formula.css">

    <template if="{{!included}}">
      <core-icon-button icon="perm-data-setting" on-click="{{showControls}}"></core-icon-button>
    </template>

    <core-collapse id="ctrl_collapse">      

            <p class="info">Calculate a mathematical formula based on column values</p>
            <label>Formula:</label>
            <input is="core-input" id="formula" value="{{formula}}" class="formula" on-change="{{}}" placeHolder="e.g. (col1 + col2) + min(col3, col4) " >
            <label>Name of the new calculated column:</label>
            <input is="core-input" commitedValue="{{colName}}">            
            <label>Available columns:</label>
            <core-selector id="col_selector" selected="{{_selectedCol}}"valueattr="label">
              <template repeat="{{attr in _dataAttributes}}">
                <div class="col" label="{{attr}}">{{attr}}</div>
              </template>
            </core-selector>
            <label>Available functions:</label>
            <core-selector id="func_selector" selected="{{_funcSelected}}" valueattr="label">
              <template repeat="{{func in _dataAttributes}}">
                <div class="col" label="{{func.label}}">{{func.name}}</div>
              </template>
            </core-selector>

  </template>
  <script src="js/parser.js"></script>
  <script>
    Polymer({

      input: [{a: 2, b: 5},{a: 6, b: 10} ],
      colName: 'result',
      //_selectedCol: 0,
      domReady: function() {
        var self = this;

        //to render available columns if any
        this.inputChanged();

        this.$.col_selector.addEventListener('core-select', function(e) {
          self._colSelected(e).bind(self);
        });
      },
      _calculateOutput: function() {

        var self = this;
        if(self.input && self.formula && self.formula.length>0) {
          try {
            var expr = Parser.parse(self.formula);
          }
          catch(e) {
            console.log(e.message);
            return;
          }
          var vars = expr.variables();

          console.log(expr);
          console.log(vars);

          

            self.output = self.input.map(function(item) {
              var unformatted = self.$.data_utility.unformatObject(item);
              try {
                item[self.colName] = expr.evaluate(unformatted);
              }
              catch(e) 
              {
                console.log(e.message);
                return;
              }
              return item;
          });

        }

      },

      inputChanged: function() {

          var self = this;
          var firstItem = self.input[0];
          if(!firstItem) {
            return;
          }
          var attributes = Object.keys(firstItem);
          
          if(JSON.stringify(self._dataAttributes) === JSON.stringify(attributes) ) {
            //self._mapChartData();
          }
          else {
            self._dataAttributes = attributes;
          }

          self._calculateOutput();          

      },  

      _colSelected: function(e) {
        var self = this;
        console.log(e);
        console.log(e.detail.isSelected);
        if(!e.detail.isSelected) {
          return;
        }

        console.log('selectedCol ', self._selectedCol);
        if(self._selectedCol) {
          self.formula = (self.formula===undefined ? '' : self.formula).concat(' '+self._selectedCol+' ');

        }
        self.$.formula.focus();





      },
      colNameChanged: function() {
        this._calculateOutput();
      },   

      formulaChanged: function() {
        this._calculateOutput();
      },

      showControls: function(e) {
        this.$.ctrl_collapse.toggle();
      },

    });
  </script>
</polymer-element>